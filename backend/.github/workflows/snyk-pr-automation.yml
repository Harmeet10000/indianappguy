name: Snyk PR Automation

on:
  schedule:
    - cron: "0 8 * * 1" # Weekly on Monday at 8 AM UTC
  workflow_dispatch:

env:
  NODE_VERSION: "22.x"

jobs:
  snyk-fix-pr:
    name: Create Snyk Fix PRs
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk fix
        id: snyk-fix
        run: |
          # Run Snyk fix and capture output
          snyk fix --json > snyk-fix-results.json || true
          
          # Check if any fixes were applied
          if [ -s snyk-fix-results.json ]; then
            echo "fixes_available=true" >> $GITHUB_OUTPUT
            echo "Snyk fixes available"
          else
            echo "fixes_available=false" >> $GITHUB_OUTPUT
            echo "No Snyk fixes available"
          fi

      - name: Create Pull Request for Security Fixes
        if: steps.snyk-fix.outputs.fixes_available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix: apply Snyk security patches"
          title: "🔒 Security: Apply Snyk vulnerability fixes"
          body: |
            ## 🔒 Automated Security Patch
            
            This PR contains automated security fixes generated by Snyk.
            
            ### 📋 Changes
            - Applied security patches for vulnerable dependencies
            - Updated package versions to secure versions
            
            ### ✅ Verification
            - [ ] All tests pass
            - [ ] No breaking changes introduced
            - [ ] Security vulnerabilities resolved
            
            ### 🤖 Automation
            This PR was automatically created by the Snyk security workflow.
            
            **Review carefully before merging!**
            
            ---
            
            For more details, check the [Snyk dashboard](https://app.snyk.io/).
          branch: snyk-security-patches
          branch-suffix: timestamp
          delete-branch: true
          labels: |
            security
            dependencies
            automated
            snyk

      - name: Upload Snyk fix results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-fix-results
          path: snyk-fix-results.json
          retention-days: 30

  notify-security-team:
    name: Notify Security Team
    runs-on: ubuntu-latest
    needs: [snyk-fix-pr]
    if: always()

    steps:
      - name: Create notification summary
        run: |
          echo "## 🔒 Snyk Security Automation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.snyk-fix-pr.result }}" == "success" ]]; then
            echo "✅ **Status:** Security patch automation completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 📋 Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "- Review any created security patch PRs" >> $GITHUB_STEP_SUMMARY
            echo "- Verify that automated tests pass" >> $GITHUB_STEP_SUMMARY
            echo "- Merge approved security patches promptly" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Security patch automation encountered issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### 🔍 Investigation Required" >> $GITHUB_STEP_SUMMARY
            echo "- Check workflow logs for errors" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Snyk token configuration" >> $GITHUB_STEP_SUMMARY
            echo "- Review repository permissions" >> $GITHUB_STEP_SUMMARY
          fi